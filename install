#!/bin/bash
# Dotfiles installation script
# Interactive setup using gum for a better UX

set -e

# Get the script directory (dotfiles root)
DOTFILES_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Check if zsh is installed (prerequisite for dotfiles)
if ! command -v zsh &> /dev/null; then
    echo "Error: zsh is required but not installed"
    echo
    echo "Install zsh first:"
    echo "  sudo pacman -S zsh"
    echo
    exit 1
fi

# Check if yay is installed (prerequisite)
if ! command -v yay &> /dev/null; then
    echo "Error: yay (AUR helper) is required but not installed"
    echo
    echo "Install yay first: https://github.com/Jguer/yay#installation"
    echo
    echo "Quick install:"
    echo "  sudo pacman -S --needed git base-devel"
    echo "  git clone https://aur.archlinux.org/yay.git"
    echo "  cd yay"
    echo "  makepkg -si"
    exit 1
fi

# Check for gum and install if needed
if ! command -v gum &> /dev/null; then
    echo "gum is required for the interactive installer"
    echo "Installing gum..."
    echo
    if yay -S --needed gum; then
        echo
        echo "✓ gum installed successfully"
    else
        echo
        echo "✗ Failed to install gum"
        exit 1
    fi
    echo
fi

gum style \
    --border double \
    --padding "1 2" \
    --border-foreground 212 \
    "Dotfiles Installation"

echo
gum style --foreground 246 "This script will help you set up your dotfiles."
echo

# Install core packages
if gum confirm "Install core packages? (required for dotfiles)"; then
    echo
    gum style --foreground 212 "Installing core packages..."
    echo

    if yay -S --needed - < "$DOTFILES_DIR/pkglist.txt"; then
        echo
        gum style --foreground 82 "✓ Core packages installed"
    else
        echo
        gum style --foreground 196 "✗ Failed to install some core packages"
        if ! gum confirm "Continue anyway?"; then
            exit 1
        fi
    fi
    echo
fi

# Install optional packages
if gum confirm "Install optional packages? (enhanced functionality)"; then
    echo
    gum style --foreground 212 "Installing optional packages..."
    echo

    if yay -S --needed - < "$DOTFILES_DIR/pkglist-optional.txt"; then
        echo
        gum style --foreground 82 "✓ Optional packages installed"
    else
        echo
        gum style --foreground 220 "⚠ Some optional packages failed to install"
    fi
    echo
fi

# Stow dotfiles
gum style --foreground 212 --bold "Dotfiles Stowing"
echo
gum style --foreground 246 "Select packages to stow (symlink to your home directory):"
echo

# Get list of stowable directories (exclude hidden dirs and files)
PACKAGES=$(find "$DOTFILES_DIR" -maxdepth 1 -type d -not -name ".*" -not -name "$(basename "$DOTFILES_DIR")" -exec basename {} \; | sort)

if [ -z "$PACKAGES" ]; then
    gum style --foreground 220 "No stowable packages found"
else
    # Convert to array for gum
    PACKAGE_ARRAY=()
    while IFS= read -r pkg; do
        PACKAGE_ARRAY+=("$pkg")
    done <<< "$PACKAGES"

    # Let user select packages to stow
    SELECTED=$(gum choose --no-limit "${PACKAGE_ARRAY[@]}" --header "Select packages (space to select, enter to confirm):")

    if [ -n "$SELECTED" ]; then
        echo
        gum style --foreground 212 "Stowing selected packages..."
        echo

        cd "$DOTFILES_DIR"

        while IFS= read -r pkg; do
            if gum spin --spinner dot --title "Stowing $pkg..." -- stow "$pkg"; then
                gum style --foreground 82 "✓ $pkg"
            else
                gum style --foreground 196 "✗ Failed to stow $pkg"
            fi
        done <<< "$SELECTED"
    else
        echo
        gum style --foreground 246 "No packages selected"
    fi
fi

echo
gum style \
    --border double \
    --padding "1 2" \
    --border-foreground 82 \
    --foreground 82 \
    --bold \
    "Installation Complete!"

echo
gum style --foreground 246 "Your dotfiles have been set up."
gum style --foreground 246 "You may need to restart your shell or log out/in for changes to take effect."
