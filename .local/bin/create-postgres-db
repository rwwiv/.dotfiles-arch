#!/usr/bin/env bash
#
# Create PostgreSQL database with user and password
# Usage: create-postgres-db <user> <pass> [db]
#
# Example:
#   create-postgres-db myuser mypass
#   create-postgres-db myuser mypass mydb

set -euo pipefail

if ! command -v psql &>/dev/null; then
  printf 'Error: psql command not found\n' >&2
  exit 1
fi

user="${1:-}"
pass="${2:-}"
db="${3:-$user}"

if [[ -z "$user" ]]; then
  printf 'Error: Missing user\n' >&2
  exit 1
fi

if [[ -z "$pass" ]]; then
  printf 'Error: Missing password\n' >&2
  exit 1
fi

# Use format string to safely quote the identifier and literal
psql -c "CREATE ROLE $(printf '%I' "$user") WITH CREATEDB ENCRYPTED PASSWORD $(printf '%L' "$pass") LOGIN;"
psql -c "ALTER USER $(printf '%I' "$user") SUPERUSER;"
psql -c "CREATE DATABASE $(printf '%I' "$db") WITH OWNER $(printf '%I' "$user");"
