#!/usr/bin/env bash
#
# Upgrade PostgreSQL data directory to match installed version

set -euo pipefail

PG_VERSION=$(sudo cat /var/lib/postgres/data/PG_VERSION)

if [[ -z "$PG_VERSION" ]]; then
    printf 'Error: Could not read PG_VERSION\n' >&2
    exit 1
fi

# Get the installed postgres version
INSTALLED_VERSION=$(/usr/bin/postgres --version | grep -oP '\d+' | head -1)

if [[ "$PG_VERSION" == "$INSTALLED_VERSION" ]]; then
    printf 'Postgres data directory is already at version %s, no upgrade needed\n' "$PG_VERSION"
    exit 0
fi

printf 'Upgrading postgres from version %s to %s\n' "$PG_VERSION" "$INSTALLED_VERSION"

if [[ ! -d "/opt/pgsql-$PG_VERSION/bin" ]]; then
    printf 'Error: Old postgres binaries not found at /opt/pgsql-%s/bin\n' "$PG_VERSION" >&2
    exit 1
fi

# Stop postgres
sudo systemctl stop postgresql

# Dir init
sudo mv /var/lib/postgres/data /var/lib/postgres/olddata
sudo mkdir /var/lib/postgres/data /var/lib/postgres/tmp
sudo chown postgres:postgres /var/lib/postgres/data /var/lib/postgres/tmp

# Begin upgrade
cd /var/lib/postgres/tmp
sudo -u postgres initdb -D /var/lib/postgres/data
sudo -u postgres pg_upgrade -b "/opt/pgsql-${PG_VERSION}/bin" -B /usr/bin -d /var/lib/postgres/olddata -D /var/lib/postgres/data
sudo -u postgres ./delete_old_cluster.sh

# Start postgres
sudo systemctl start postgresql

sudo -u postgres vacuumdb --all --analyze-in-stages --jobs="$(nproc)"
