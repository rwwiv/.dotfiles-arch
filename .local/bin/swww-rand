#!/usr/bin/env bash
#
# Set a random wallpaper using swww, cycling through all wallpapers before repeating

set -euo pipefail

WALLPAPER_DIR="$HOME/Wallpapers"
CURRENT_WALL="$HOME/.config/wallpaper"
HISTORY_FILE="$HOME/.cache/swww-rand-history"

# Ensure cache directory exists
mkdir -p "$(dirname "$HISTORY_FILE")"

# Get all available wallpapers
ALL_WALLS=$(find "$WALLPAPER_DIR" -type f)

# Get wallpapers not yet used (not in history)
UNUSED_WALLS=""
if [[ -f "$HISTORY_FILE" ]]; then
    UNUSED_WALLS=$(printf '%s' "$ALL_WALLS" | grep -vxFf "$HISTORY_FILE" || true)
else
    UNUSED_WALLS="$ALL_WALLS"
fi

# If all wallpapers have been used, reset history
if [[ -z "$UNUSED_WALLS" ]]; then
    rm -f "$HISTORY_FILE"
    UNUSED_WALLS="$ALL_WALLS"
fi

# Pick a random wallpaper from unused ones
NEW_WALL=$(printf '%s' "$UNUSED_WALLS" | shuf -n 1)

# Add to history
printf '%s\n' "$NEW_WALL" >> "$HISTORY_FILE"

ln -nsf "$NEW_WALL" "$CURRENT_WALL"
swww img "$NEW_WALL" --transition-type fade --transition-duration 1
