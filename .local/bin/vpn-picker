#!/usr/bin/env bash

# VPN Picker - Powered by Gum
# Requires: gum, tailscale, wg-quick (sudo)

WG_IFACE="wg0"
WG_CONF_DIR="$HOME/.config/wireguard"
WG_SYMLINK="$WG_CONF_DIR/wg0.conf"
CACHE_FILE="$HOME/.cache/vpn-last-used"

# Colors (using theme)
C_ON="2"      # Green
C_OFF="8"     # Grey
C_ACCENT="4"  # Blue
C_WARN="3"    # Yellow

# ─────────────────────────────────────────────────
# Helpers
# ─────────────────────────────────────────────────

get_pretty_name() {
    local name
    name=$(basename "${1%.*}")
    echo "$name" | tr -- '-_' '  '
}

# Resize window to fit content (width_chars, height_lines)
resize_window() {
    local cols="$1" lines="$2"
    # Get current font metrics from terminal
    # Ghostty: ~10px per char width, ~20px per line (approximate)
    local char_width=10 line_height=22
    local width=$((cols * char_width))
    local height=$((lines * line_height))

    hyprctl --batch "dispatch resizeactive exact $width $height; dispatch centerwindow" &>/dev/null
}

# ─────────────────────────────────────────────────
# Status Fetchers
# ─────────────────────────────────────────────────

get_tailscale_status() {
    local ts_state
    ts_state=$(tailscale status --json 2>/dev/null | jq -r '.BackendState' 2>/dev/null)

    if [[ "$ts_state" == "Running" ]]; then
        TS_ON=true
    else
        TS_ON=false
    fi

    # Get selected exit node from exit-node list
    TS_EXIT_NODE=""
    local line
    while IFS= read -r line; do
        if [[ "$line" =~ selected ]]; then
            read -r _ip hostname _rest <<< "$line"
            TS_EXIT_NODE="${hostname%%.*}"
            break
        fi
    done <<< "$(tailscale exit-node list 2>/dev/null)"
}

get_wireguard_status() {
    WG_ON=false
    WG_PROFILE=""

    if [[ -L "$WG_SYMLINK" ]]; then
        WG_PROFILE=$(get_pretty_name "$(readlink -f "$WG_SYMLINK")")
    fi

    if ip link show "$WG_IFACE" &>/dev/null && ip link show "$WG_IFACE" | grep -q "UP"; then
        WG_ON=true
    fi
}

# ─────────────────────────────────────────────────
# Actions
# ─────────────────────────────────────────────────

tailscale_connect() {
    if [[ "$WG_ON" == true ]]; then
        gum spin --spinner dot --title "Stopping WireGuard..." -- sudo wg-quick down "$WG_SYMLINK"
    fi
    gum spin --spinner dot --title "Connecting Tailscale..." -- tailscale up
    echo "tailscale" > "$CACHE_FILE"
}

tailscale_disconnect() {
    gum spin --spinner dot --title "Disconnecting Tailscale..." -- tailscale down
}

wireguard_connect() {
    if [[ "$TS_ON" == true ]]; then
        gum spin --spinner dot --title "Stopping Tailscale..." -- tailscale down
    fi
    # Cleanup zombie interface
    if ip link show "$WG_IFACE" &>/dev/null; then
        sudo wg-quick down "$WG_SYMLINK" &>/dev/null || sudo ip link delete "$WG_IFACE" &>/dev/null
    fi
    gum spin --spinner dot --title "Connecting WireGuard..." -- sudo wg-quick up "$WG_SYMLINK"
    echo "wireguard" > "$CACHE_FILE"
}

wireguard_disconnect() {
    gum spin --spinner dot --title "Disconnecting WireGuard..." -- sudo wg-quick down "$WG_SYMLINK"
}

# ─────────────────────────────────────────────────
# Menus
# ─────────────────────────────────────────────────

show_header() {
    resize_window 50 5
    clear
}

menu_main() {
    local ts_status wg_status ts_detail="" wg_detail=""

    # Build Tailscale status
    if [[ "$TS_ON" == true ]]; then
        ts_status=$(gum style --foreground "$C_ON" "● ON")
    else
        ts_status=$(gum style --foreground "$C_OFF" "○ OFF")
    fi
    [[ -n "$TS_EXIT_NODE" ]] && ts_detail=" → $TS_EXIT_NODE"

    # Build WireGuard status
    if [[ "$WG_ON" == true ]]; then
        wg_status=$(gum style --foreground "$C_ON" "● ON")
        [[ -n "$WG_PROFILE" ]] && wg_detail=" → $WG_PROFILE"
    else
        wg_status=$(gum style --foreground "$C_OFF" "○ OFF")
        [[ -n "$WG_PROFILE" ]] && wg_detail=" → $WG_PROFILE"
    fi

    gum choose \
        --cursor.foreground "$C_ACCENT" \
        --selected.foreground "$C_ACCENT" \
        "Tailscale    $ts_status$ts_detail" \
        "WireGuard    $wg_status$wg_detail" \
        "Exit"
}

menu_tailscale() {
    # 5 items + header + padding
    resize_window 45 8

    while true; do
        local opts=()

        if [[ "$TS_ON" == true ]]; then
            opts+=("Disconnect")
        else
            opts+=("Connect")
        fi

        opts+=("Change Exit Node")
        opts+=("Preferences")
        opts+=("Open Admin Console")
        opts+=("Back")

        local choice
        choice=$(gum choose \
            --cursor.foreground "$C_ACCENT" \
            --header "Tailscale" \
            --header.foreground "$C_ACCENT" \
            "${opts[@]}")

        case "$choice" in
            "Connect")
                tailscale_connect
                return
                ;;
            "Disconnect")
                tailscale_disconnect
                return
                ;;
            "Change Exit Node")
                menu_exit_nodes
                ;;
            "Preferences")
                menu_tailscale_prefs
                ;;
            "Open Admin Console")
                xdg-open "http://100.100.100.100" &>/dev/null &
                ;;
            "Back"|"")
                return
                ;;
        esac

        # Refresh status after actions
        get_tailscale_status
    done
}

menu_wireguard() {
    # 3 items + header + padding
    resize_window 40 6

    while true; do
        local opts=()

        if [[ "$WG_ON" == true ]]; then
            opts+=("Disconnect")
        else
            opts+=("Connect")
        fi

        opts+=("Select Profile")
        opts+=("Back")

        local choice
        choice=$(gum choose \
            --cursor.foreground "$C_ACCENT" \
            --header "WireGuard" \
            --header.foreground "$C_ACCENT" \
            "${opts[@]}")

        case "$choice" in
            "Connect")
                wireguard_connect
                return
                ;;
            "Disconnect")
                wireguard_disconnect
                return
                ;;
            "Select Profile")
                menu_wireguard_profiles
                ;;
            "Back"|"")
                return
                ;;
        esac

        # Refresh status after actions
        get_wireguard_status
    done
}

menu_exit_nodes() {
    gum spin --spinner dot --title "Fetching exit nodes..." -- sleep 0.3

    local nodes_output node_opts=() current_node="" node_count=0
    nodes_output=$(tailscale exit-node list 2>/dev/null)

    node_opts+=("None (direct)")

    while IFS= read -r line; do
        [[ -z "$line" || "$line" =~ ^# || "$line" =~ HOSTNAME ]] && continue
        read -r _ip hostname _rest <<< "$line"
        [[ -z "$hostname" ]] && continue

        local simple="${hostname%%.*}"
        if [[ "$line" =~ selected ]]; then
            current_node="$simple"
            node_opts+=("$simple (current)")
        else
            node_opts+=("$simple")
        fi
        ((node_count++))
    done <<< "$nodes_output"

    [[ -z "$current_node" ]] && node_opts[0]="None (current)"

    node_opts+=("Back")

    # Dynamic height: nodes + "None" + "Back" + header + padding
    resize_window 45 $((node_count + 5))

    local choice
    choice=$(gum choose \
        --cursor.foreground "$C_ACCENT" \
        --header "Select Exit Node" \
        --header.foreground "$C_ACCENT" \
        "${node_opts[@]}")

    case "$choice" in
        "Back"|"") return ;;
        "None"*|"None (direct)"*)
            gum spin --spinner dot --title "Clearing exit node..." -- tailscale set --exit-node ""
            ;;
        *)
            local node="${choice% (current)}"
            gum spin --spinner dot --title "Setting exit node: $node..." -- tailscale set --exit-node "$node"
            ;;
    esac
}

menu_tailscale_prefs() {
    # 5 toggles + "Back" + header + padding
    resize_window 45 9

    while true; do
        local prefs opts=()
        prefs=$(tailscale debug prefs 2>/dev/null)

        local p_routes p_dns p_lan p_ssh p_shields
        p_routes=$(echo "$prefs" | jq -r '.RouteAll')
        p_dns=$(echo "$prefs" | jq -r '.CorpDNS')
        p_lan=$(echo "$prefs" | jq -r '.ExitNodeAllowLANAccess')
        p_ssh=$(echo "$prefs" | jq -r '.RunSSH')
        p_shields=$(echo "$prefs" | jq -r '.ShieldsUp')

        fmt() {
            if [[ "$1" == "true" ]]; then
                gum style --foreground "$C_ON" "ON "
            else
                gum style --foreground "$C_OFF" "OFF"
            fi
        }

        opts+=("Accept Routes        $(fmt "$p_routes")")
        opts+=("Accept DNS           $(fmt "$p_dns")")
        opts+=("Allow LAN Access     $(fmt "$p_lan")")
        opts+=("Run SSH Server       $(fmt "$p_ssh")")
        opts+=("Block Incoming       $(fmt "$p_shields")")
        opts+=("Back")

        local choice
        choice=$(gum choose \
            --cursor.foreground "$C_ACCENT" \
            --header "Tailscale Preferences (toggle)" \
            --header.foreground "$C_ACCENT" \
            "${opts[@]}")

        case "$choice" in
            *"Back"*|"") return ;;
            *"Accept Routes"*)
                local new_val=$([[ "$p_routes" == "true" ]] && echo "false" || echo "true")
                tailscale set --accept-routes="$new_val"
                ;;
            *"Accept DNS"*)
                local new_val=$([[ "$p_dns" == "true" ]] && echo "false" || echo "true")
                tailscale set --accept-dns="$new_val"
                ;;
            *"Allow LAN"*)
                local new_val=$([[ "$p_lan" == "true" ]] && echo "false" || echo "true")
                tailscale set --exit-node-allow-lan-access="$new_val"
                ;;
            *"Run SSH"*)
                local new_val=$([[ "$p_ssh" == "true" ]] && echo "false" || echo "true")
                tailscale set --ssh="$new_val"
                ;;
            *"Block Incoming"*)
                local new_val=$([[ "$p_shields" == "true" ]] && echo "false" || echo "true")
                tailscale set --shields-up="$new_val"
                ;;
        esac
    done
}

menu_wireguard_profiles() {
    local profiles=() paths=()

    shopt -s nullglob
    for conf in "$WG_CONF_DIR"/*.conf; do
        [[ "$(basename "$conf")" == "wg0.conf" ]] && continue
        local pretty
        pretty=$(get_pretty_name "$conf")
        if [[ "$pretty" == "$WG_PROFILE" ]]; then
            profiles+=("$pretty (current)")
        else
            profiles+=("$pretty")
        fi
        paths+=("$conf")
    done
    shopt -u nullglob

    profiles+=("Back")

    # Dynamic height: profiles + "Back" + header + padding
    resize_window 45 $((${#profiles[@]} + 3))

    local choice
    choice=$(gum choose \
        --cursor.foreground "$C_ACCENT" \
        --header "Select WireGuard Profile" \
        --header.foreground "$C_ACCENT" \
        "${profiles[@]}")

    [[ "$choice" =~ Back || -z "$choice" ]] && return

    # Find matching path
    local selected_path=""
    for i in "${!profiles[@]}"; do
        if [[ "${profiles[$i]}" == "$choice" ]]; then
            selected_path="${paths[$i]}"
            break
        fi
    done

    [[ -z "$selected_path" ]] && return

    # Stop any active VPN
    [[ "$TS_ON" == true ]] && tailscale_disconnect
    [[ "$WG_ON" == true ]] && wireguard_disconnect

    # Switch and connect
    ln -sf "$selected_path" "$WG_SYMLINK"
    wireguard_connect
}

# ─────────────────────────────────────────────────
# Main Loop
# ─────────────────────────────────────────────────

while true; do
    get_tailscale_status
    get_wireguard_status

    show_header

    choice=$(menu_main)

    case "$choice" in
        Tailscale*) menu_tailscale ;;
        WireGuard*) menu_wireguard ;;
        "Exit"|"")  clear; exit 0 ;;
    esac
done
