#!/bin/bash

WALLPAPER="$HOME/.config/omarchy/current/background"

apply_wallpaper() {
  swww img "$WALLPAPER" --transition-type none
}

handle() {
  case $1 in
    monitoraddedv2) apply_wallpaper ;;
  esac
}

use_swaybg() {
  swaybg -i "$WALLPAPER" -m fill
}

if command -v swww &> /dev/null; then
  swww-daemon &

  wait_cnt=0
  while ! swww query &>/dev/null; do
    if [ $wait_cnt -gt 50 ]; then
      echo "Failed to start swww"
      use_swaybg
      exit 1
    fi
    sleep 0.1
    wait_cnt=$((wait_cnt + 1))
  done

  apply_wallpaper

  wait_cnt=0
  while ! pgrep swaybg &>/dev/null; do
    if [ $wait_cnt -gt 50 ]; then
      echo "swaybg not running"
      break
    fi
    sleep 0.1
    wait_cnt=$((wait_cnt + 1))
  done

  pkill swaybg &>/dev/null

  socat -U - UNIX-CONNECT:$XDG_RUNTIME_DIR/hypr/$HYPRLAND_INSTANCE_SIGNATURE/.socket2.sock | while read -r line; do handle "$line"; done
else
  use_swaybg
fi
