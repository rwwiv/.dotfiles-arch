#!/usr/bin/env python3
import asyncio
import sys
import os
import subprocess
import signal

# Expand path for library
sys.path.append(os.path.expanduser("~/.config/hypr/scripts/lib"))
from hyprland_ipc import Hyprland

# Config
WALLPAPER_PATH = os.path.expanduser("~/.config/omarchy/current/background")
SWAYBG_TIMEOUT = 10

h = Hyprland()


async def init_swww() -> None:
    """Ensures daemon is running. If started here, it survives this script (orphaned intentional)."""
    try:
        proc = await asyncio.create_subprocess_exec(
            "pgrep", "-x", "swww-daemon", stdout=asyncio.subprocess.DEVNULL
        )
        await proc.wait()

        if proc.returncode != 0:
            # Popen spawns it as a detached process relative to asyncio loop
            subprocess.Popen(
                ["swww-daemon"], stdout=subprocess.DEVNULL, stderr=subprocess.DEVNULL
            )
            await asyncio.sleep(1.0)
    except Exception:
        pass


async def set_wallpaper() -> None:
    if not os.path.exists(WALLPAPER_PATH):
        return

    try:
        # Fire and forget
        subprocess.Popen(
            ["swww", "img", WALLPAPER_PATH, "--transition-type", "none"],
            stdout=subprocess.DEVNULL,
            stderr=subprocess.DEVNULL,
        )
    except Exception:
        pass


# Add to global scope
wallpaper_task = None


async def delayed_paint():
    try:
        await asyncio.sleep(1.0)  # Wait 1s for displays to align
        await set_wallpaper()
    except asyncio.CancelledError:
        pass


@h.on("monitoraddedv2")
async def handle_monitor_hotplug(ctx: Hyprland, data: str) -> None:
    global wallpaper_task
    if wallpaper_task:
        wallpaper_task.cancel()
    wallpaper_task = asyncio.create_task(delayed_paint())


async def shutdown(signal_loop):
    """Cleanup tasks on SIGTERM"""
    tasks = [t for t in asyncio.all_tasks() if t is not asyncio.current_task()]
    [task.cancel() for task in tasks]
    await asyncio.gather(*tasks, return_exceptions=True)
    signal_loop.stop()


def main() -> None:
    loop = asyncio.new_event_loop()
    asyncio.set_event_loop(loop)

    # Handle Hyprland kill signal (SIGTERM)
    for sig in (signal.SIGTERM, signal.SIGINT):
        loop.add_signal_handler(sig, lambda: asyncio.create_task(shutdown(loop)))

    try:
        loop.run_until_complete(init_swww())
        loop.run_until_complete(set_wallpaper())

        # Start IPC listener
        loop.run_until_complete(h._listen())
    except asyncio.CancelledError:
        pass
    finally:
        loop.close()


if __name__ == "__main__":
    main()
