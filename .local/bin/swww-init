#!/usr/bin/env python3
"""Initialize swww wallpaper daemon and handle monitor hotplug events."""

from __future__ import annotations

import asyncio
import signal
import subprocess
import sys
from pathlib import Path

# Expand path for library
sys.path.append(str(Path.home() / ".config/hypr/scripts/lib"))
from hyprland_ipc import Hyprland  # noqa: E402

# Config
WALLPAPER_PATH = Path.home() / ".config/wallpaper"

hyprland = Hyprland()
wallpaper_task: asyncio.Task | None = None


async def init_swww() -> None:
    """Ensure swww daemon is running. If started here, it survives this script."""
    try:
        proc = await asyncio.create_subprocess_exec(
            "pgrep", "-x", "swww-daemon", stdout=asyncio.subprocess.DEVNULL
        )
        await proc.wait()

        if proc.returncode != 0:
            # Popen spawns it as a detached process relative to asyncio loop
            subprocess.Popen(
                ["swww-daemon"],
                stdout=subprocess.DEVNULL,
                stderr=subprocess.DEVNULL,
            )
            await asyncio.sleep(1.0)
    except Exception:
        pass


async def set_wallpaper() -> None:
    """Set the wallpaper using swww."""
    if not WALLPAPER_PATH.exists():
        return

    try:
        subprocess.Popen(
            ["swww", "img", str(WALLPAPER_PATH), "--transition-type", "none"],
            stdout=subprocess.DEVNULL,
            stderr=subprocess.DEVNULL,
        )
    except Exception:
        pass


async def delayed_paint() -> None:
    """Wait for displays to settle, then set wallpaper."""
    try:
        await asyncio.sleep(1.0)
        await set_wallpaper()
    except asyncio.CancelledError:
        pass


@hyprland.on("monitoraddedv2")
async def handle_monitor_hotplug(ctx: Hyprland, data: str) -> None:
    """Handle monitor hotplug by refreshing wallpaper."""
    global wallpaper_task
    if wallpaper_task is not None:
        wallpaper_task.cancel()
    wallpaper_task = asyncio.create_task(delayed_paint())


async def shutdown(loop: asyncio.AbstractEventLoop) -> None:
    """Clean up tasks on SIGTERM."""
    tasks = [t for t in asyncio.all_tasks() if t is not asyncio.current_task()]
    for task in tasks:
        task.cancel()
    await asyncio.gather(*tasks, return_exceptions=True)
    loop.stop()


def main() -> None:
    """Main entry point."""
    loop = asyncio.new_event_loop()
    asyncio.set_event_loop(loop)

    # Handle Hyprland kill signal (SIGTERM)
    for sig in (signal.SIGTERM, signal.SIGINT):
        loop.add_signal_handler(sig, lambda: asyncio.create_task(shutdown(loop)))

    try:
        loop.run_until_complete(init_swww())
        loop.run_until_complete(set_wallpaper())
        # Start IPC listener
        loop.run_until_complete(hyprland._listen())
    except asyncio.CancelledError:
        pass
    finally:
        loop.close()


if __name__ == "__main__":
    main()
