#!/usr/bin/env python3
"""Universal brightness control for internal and external (DDC) displays."""

from __future__ import annotations

import json
import re
import subprocess
import sys


def get_focused_monitor() -> tuple[str, str]:
    """
    Get the focused monitor's name and model.

    Returns:
        Tuple of (name, model) for the focused monitor.
    """
    try:
        out = subprocess.check_output(["hyprctl", "monitors", "-j"], text=True)
        monitors = json.loads(out)
        for m in monitors:
            if m["focused"]:
                return m["name"], m["model"]
    except Exception:
        sys.exit(1)
    return "", ""


def get_ddc_display(target_model: str) -> str | None:
    """
    Find ddcutil display number by matching product name to model.

    Args:
        target_model: The monitor model to search for.

    Returns:
        Display ID string or None if not found.
    """
    try:
        out = subprocess.check_output(["ddcutil-client", "list"], text=True)
        current_disp = None

        for line in out.splitlines():
            line = line.strip()
            if line.startswith("display:"):
                current_disp = line.split(":", 1)[1].strip()
            elif line.startswith("product_name:"):
                p_name = line.split(":", 1)[1].strip()
                # Fuzzy match because EDID strings are messy
                if target_model in p_name or p_name in target_model:
                    return current_disp
    except Exception:
        pass
    return None


def set_internal_brightness(delta: str, monitor_name: str) -> None:
    """Pass-through for internal laptop displays using swayosd."""
    subprocess.run(
        ["swayosd-client", "--brightness", delta, "--monitor", monitor_name],
        check=False,
    )


def set_external_brightness(delta_int: int, display_id: str, monitor_name: str) -> None:
    """
    Set brightness on external DDC-capable monitors.

    Args:
        delta_int: Brightness change amount (positive or negative).
        display_id: DDC display identifier.
        monitor_name: Monitor name for OSD display.
    """
    try:
        # Get current brightness (VCP 10)
        out = subprocess.check_output(
            ["ddcutil-client", "-d", display_id, "getvcp", "10"], text=True
        )

        # Parse current and max values
        curr_match = re.search(r"vcp_current_value:\s+(\d+)", out)
        max_match = re.search(r"vcp_max_value:\s+(\d+)", out)

        if not curr_match:
            return

        current = int(curr_match.group(1))
        maximum = int(max_match.group(1)) if max_match else 100

        # Calculate new value, clamped to valid range
        new_val = max(0, min(maximum, current + delta_int))

        if new_val == current:
            return

        # Set new brightness
        subprocess.run(
            ["ddcutil-client", "-d", display_id, "setvcp", "10", str(new_val)],
            check=True,
        )

        # Update OSD (using custom values since swayosd can't read DDC)
        progress = new_val / maximum
        subprocess.run(
            [
                "swayosd-client",
                "--custom-icon",
                "display-brightness-symbolic",
                "--custom-progress",
                f"{progress:.2f}",
                "--monitor",
                monitor_name,
            ],
            check=False,
        )

    except Exception as e:
        print(f"DDC Error: {e}", file=sys.stderr)


def main() -> int:
    """Main entry point."""
    if len(sys.argv) < 2:
        print("Usage: uni-brightness [+|-]VAL", file=sys.stderr)
        return 1

    delta_str = sys.argv[1]
    try:
        delta_int = int(delta_str)
    except ValueError:
        print(f"Error: Invalid brightness value '{delta_str}'", file=sys.stderr)
        return 1

    name, model = get_focused_monitor()

    # Internal display detection: eDP or LVDS prefixes
    if name.startswith(("eDP", "LVDS")):
        set_internal_brightness(delta_str, name)
    else:
        # Try to find DDC display
        ddc_id = get_ddc_display(model)
        if ddc_id:
            set_external_brightness(delta_int, ddc_id, name)
        else:
            # Fallback: external without DDC support, try swayosd anyway
            set_internal_brightness(delta_str, name)

    return 0


if __name__ == "__main__":
    sys.exit(main())
