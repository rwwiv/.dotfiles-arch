#!/bin/bash
# @systemd

NIGHT_TEMP=4000
ENABLED=false
PID_FILE="${XDG_RUNTIME_DIR}/nightlight.pid"

# Ensure hyprsunset is running
if ! pgrep -x hyprsunset; then
  setsid uwsm-app -- hyprsunset &
  sleep 1 # Give it time to register
fi

restart_nightlighted_waybar() {
	if grep -q "custom/nightlight" ~/.config/waybar/config.jsonc; then
		omarchy-restart-waybar # restart waybar in case user has waybar module for hyprsunset
	fi
}

toggle() {
	if $ENABLED; then
		# reset gamma before disabling the filter
		hyprctl hyprsunset gamma 100 >/dev/null 2>&1
		hyprctl hyprsunset identity >/dev/null 2>&1
		notify-send "   Daylight screen temperature"
		echo "[Nightlight] Disabled"
		ENABLED=false
	else
		hyprctl hyprsunset gamma 75 >/dev/null 2>&1
		hyprctl hyprsunset temperature $NIGHT_TEMP >/dev/null 2>&1
		notify-send "  Nightlight screen temperature"
		echo "[Nightlight] Enabled"
		ENABLED=true
	fi
	restart_nightlighted_waybar
}

cleanup() {
	rm -f "$PID_FILE"
	exit 0
}

trap toggle SIGUSR1
trap cleanup SIGTERM SIGINT

echo $$ > "$PID_FILE"
echo "[Nightlight] Service started (PID: $$)"

# Keep running
while true; do
	sleep infinity &
	wait
done
