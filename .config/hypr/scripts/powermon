#!/usr/bin/env python3
# @systemd
import subprocess
import sys
import os
import asyncio
import glob

# --- CONFIGURATION ---
BATTERY_PROFILE = "power-saver"
AC_PROFILE = "balanced"

def get_power_source():
    """
    Checks sysfs for AC adapter status. 
    Returns 'line-power' if ANY Mains adapter is online, else 'battery'.
    """
    for path in glob.glob("/sys/class/power_supply/*"):
        try:
            with open(os.path.join(path, "type"), "r") as f:
                if "Mains" not in f.read(): continue
            with open(os.path.join(path, "online"), "r") as f:
                if f.read().strip() == "1": return "line-power"
        except OSError:
            continue
    return "battery"

def notify(title, message, icon):
    """Sends a notification via notify-send."""
    try:
        subprocess.run(
            ["notify-send", "-u", "low", "-i", icon, title, message],
            stdout=subprocess.DEVNULL,
            stderr=subprocess.DEVNULL
        )
    except Exception:
        pass

def apply_mode(mode):
    if mode == "battery":
        print("[Power] Engaging Battery Mode")
        subprocess.run(["powerprofilesctl", "set", BATTERY_PROFILE], stdout=subprocess.DEVNULL)
        notify("Power Profile", f"Switched to {BATTERY_PROFILE}", "battery-level-60-symbolic")
    else:
        print("[Power] Engaging AC Mode")
        subprocess.run(["powerprofilesctl", "set", AC_PROFILE], stdout=subprocess.DEVNULL)
        notify("Power Profile", f"Switched to {AC_PROFILE}", "battery-level-100-charged-symbolic")

async def monitor_power():
    print("[Power] Starting monitoring...")
    
    current_source = get_power_source()
    print(f"[Power] Initial State: {current_source}")
    apply_mode(current_source)

    # Monitor upower output as a trigger mechanism only
    proc = subprocess.Popen(
        ["upower", "--monitor"],
        stdout=subprocess.PIPE,
        stderr=subprocess.DEVNULL,
        text=True,
        bufsize=1
    )

    try:
        for line in iter(proc.stdout.readline, ''):
            # Trigger on AC or Battery events
            if "line_power" in line or "battery" in line:
                new_source = get_power_source()
                if new_source != current_source:
                    print(f"[Power] Change detected: {current_source} -> {new_source}")
                    current_source = new_source
                    apply_mode(current_source)
    except Exception as e:
        print(f"Error: {e}")
    finally:
        proc.kill()

if __name__ == "__main__":
    try:
        asyncio.run(monitor_power())
    except KeyboardInterrupt:
        pass
